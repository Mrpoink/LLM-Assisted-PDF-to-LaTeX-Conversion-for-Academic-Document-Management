=====FILE: main.tex=====
\documentclass[11pt,twocolumn]{article}

\usepackage[margin=1in]{geometry}
\usepackage{amsmath,amssymb}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{url}

\title{%%%PLACEHOLDER: PARA_0001%%%}
\author{%%%PLACEHOLDER: PARA_0002%%%}

\date{}

\begin{document}
\maketitle

\begin{abstract}
Neural Machine Translation (NMT) models can be specialized by domain adaptation, often involving fine-tuning on a dataset of interest. This process risks catastrophic forgetting: rapid loss of generic translation quality. Forgetting has been widely observed, with many mitigation methods proposed. However, the causes of forgetting and the relationship between forgetting and adaptation data are under-explored.

This paper takes a novel approach to understanding catastrophic forgetting during NMT adaptation by investigating the impact of the data. We provide a first investigation of what is forgotten, and why. We examine the relationship between forgetting and the in-domain data, and show that the amount and type of forgetting is linked to that data's target vocabulary coverage. Our findings pave the way toward better informed NMT domain adaptation.

typically referencing lower scores in some quality metric. However, prior work on forgetting in NMT focuses on mitigation, leaving two important gaps. Firstly, prior work does not determine what is forgotten in concrete terms. Lower scores in a reference-based quality metric can indicate either poor translation or simply a vocabulary shift towards the new domain. This is especially true for string-based metrics like BLEU (Papineni et al., 2002). Prior work does not distinguish between quality drop and vocabulary shift, and further does not address whether vocabulary shift 'forgetting' is beneficial or detrimental to translation of the generic and new domains.

Secondly, prior work almost universally treats forgetting and its mitigation as independent of the adaptation dataset. In fact, the contents of the adaptation dataset will impact forgetting - consider the amount of forgetting expected if fine-tuning on a 1000-sentence sample of the pre-training dataset, versus 1000 copies of the same sentence pair. Understanding the relationship between adaptation data and forgetting is crucial for predicting how well domain adaptation will work, whether adapted performance is likely to generalise, or whether forgetting mitigation approaches are necessary.

\end{abstract}

\section{Introduction}
The specialization of Neural Machine Translation (NMT) models for high performance in a specific domain, such as legal or healthcare, is of strong interest to academia (Barrault et al., 2020) and industry (Savenkov and Lopez, 2022). Fine-tuning, sometimes known as transfer learning, is a well-established domain adaptation method that continues training a pre-trained NMT model on some new dataset from the domain of interest (Luong and Manning, 2015). However, fine-tuning on domain-shifted data can result in catastrophic forgetting (McCloskey and Cohen, 1989).

This apparently simple statement has been widely observed in NMT, but rarely examined. Catastrophic forgetting in NMT is described variously as `degradation of general-domain performance' (Thompson et al., 2019) or `[forgetting] previous domain knowledge' (Gu and Feng, 2020), typically referencing lower scores in some quality metric. However, prior work on forgetting in NMT focuses on mitigation, leaving two important gaps. Firstly, prior work does not determine what is forgotten in concrete terms. Lower scores in a reference-based quality metric can indicate either poor translation or simply a vocabulary shift towards the new domain. This is especially true for string-based metrics like BLEU (Papineni et al., 2002). Prior work does not distinguish between quality drop and vocabulary shift, and further does not address whether vocabulary shift `forgetting' is beneficial or detrimental to translation of the generic and new domains.

Secondly, prior work almost universally treats forgetting and its mitigation as independent of the adaptation dataset. In fact, the contents of the adaptation dataset will impact forgetting -- consider the amount of forgetting expected if fine-tuning on a 1000-sentence sample of the pre-training dataset, versus 1000 copies of the same sentence pair. Understanding the relationship between adaptation data and forgetting is crucial for predicting how well domain adaptation will work, whether adapted performance is likely to generalise, or whether forgetting mitigation approaches are necessary.

The contributions of this paper lie in addressing these gaps. Specifically:
\begin{itemize}
\item We provide a first exploration of what domain-adapted NMT forgets. This includes quantifying the degree of detrimental vocabulary shift, and demonstrating that this shift is not well-characterised by common MT quality metrics.
\item We show that forgetting can consist of using in-domain vocabulary inappropriately in out-of-vocabulary contexts -- and, unexpectedly, that this can take place even when the source sentence has no in-domain triggers.
\item We also provide a first investigation into the relationship between forgetting and adaptation dataset, examining the correlation between forgetting and several domain heuristics for eight domains across two language pairs.
\item We find that some commonly used domain heuristics including sentence pair count and vocabulary distribution cannot explain how forgetting varies by domain, but that forgetting does have a strong relationship with generic vocabulary coverage.
\item We support our findings by demonstrating significantly reduced forgetting with minimal, coverage-based mixed fine-tuning. In the process we show that much of the benefit of generic data mix-in comes from a relatively small vocabulary-covering set.
\end{itemize}


\subsection{Related work}
NMT adaptation with the goal of improved in-domain performance sometimes accounts for domain-specific data characteristics. Examples include selecting adaptation data by target domain similarity (Aharoni and Goldberg, 2020), gradually emphasising in-domain data during training (Zhang et al., 2019), or determining hyperparameters via meta-learning (Sharaf et al., 2020).

Work focusing on catastrophic forgetting in NMT, by contrast, takes an adaptation-set-agnostic approach depending only on the \textit{generic} dataset (Saunders, 2022). This can include regularizing parameters relative to the generic domain (Barone et al., 2017), training on complementary inputs via generic-trained teacher models (Shao and Feng, 2022) or mixing in generic data during adaptation (Chu et al., 2017).

The specific \textit{adaptation} dataset is not typically considered beyond broad suggestions such as tuning for fewer steps on smaller datasets (Xu et al., 2019). In this work, by contrast, we aim to understand forgetting based on the characteristics of the domain-specific adaptation dataset.


\section{What does adapted NMT forget?}
In this section, we explore what is forgotten during adaptation in concrete terms, using two quality metrics and a new measure for analysing vocabulary shift. We adapt pre-trained generic NMT models to eight diverse domains across two language pairs, intentionally triggering catastrophic forgetting, and analyse the degree of quality degradation versus vocabulary shift. In particular, we examine which tokens are forgotten and what replaces them after adaptation. We find that models experiencing forgetting produce in-domain vocabulary incorrectly and in entirely out-of-domain contexts.


\subsection{Measuring vocabulary-shift forgetting}
To determine which tokens are forgotten during adaptation we propose a new forgetting measure. Prior work measures forgetting via a drop in a corpus-level quality metric (Thompson et al., 2019; Gu and Feng, 2020). However, these do not mark which terms are forgotten. To measure vocabulary shift forgetting, a score should highlight terms that are used correctly \textit{before} but not \textit{after} adaptation. We focus on unigram terms: these are easily interpretable with respect to the vocabulary, which often signifies domain (van der Wees et al., 2015).

Consider a test set where for each reference translation $T_R$ we can compare a translation from an original model $T_O$ and a translation from an adapted model $T_A$. We are interested in how the adapted model translation changes relative to the original model translation and the reference. For each reference $T_R$, we find the count of every reference token in original model and adapted model translations, $#tok_O$ and $#tok_A$, capped at the count in the reference $#tok_R$:
\begin{align*}
O[tok]*{T_R} &= \min(#tok_O, #tok_R) \
A[tok]*{T_R} &= \min(#tok_A, #tok_R) \
\textit{ForgetGenUse}[tok] &= \sum_{T_R}\max(O[tok]*{T_R} - A[tok]*{T_R}, 0)
\end{align*}

High $\textit{ForgetGenUse}[tok]$ means we forget generic use of $tok$. For example, if the generic model correctly produced $tok$ $N$ times and the adapted model did not produce it at all, $\textit{ForgetGenUse}[tok]=N$: all generic uses of $tok$ are forgotten. If the generic and adapted models both fail to produce $tok$ at all, $\textit{ForgetGenUse}[tok]=0$ -- this is a quality problem but not specific to forgetting.

A normalized corpus-level score over a set of multiple tokens, $V$, is given by:
\begin{equation}
\tag{1}
\textit{ForgetGenUse}*{V}=
\frac{\sum*{tok\in V}\textit{ForgetGenUse}[tok]}
{\sum_{T_R}\sum_{tok\in V}#tok_R}
\end{equation}

$V$ could consist of all tokens ($T_{All}$) -- in which case the denominator is the test set reference token count -- or a subset, for example, out-of-domain (OOD) tokens, in which case the denominator is the count of just those tokens in all reference sentences. We report \textit{ForgetGenUse} over subword-level tokens for brevity and ease of interpretation, but could equally calculate over words or n-grams, if we wished to extend measurement to better reflect style or syntax.

\textit{ForgetGenUse} is related to change in unigram BLEU, but there are two crucial differences. First, it is defined for all occurrences of given tokens, whereas BLEU is defined on given segments which will include some instances of a token but not others. Secondly, BLEU masks detrimental vocabulary shift with beneficial shift where a token is translated correctly after adaptation but not before. If a score remains unchanged, some (e.g.\ out-of-domain) tokens may be translated worse, and others better. We are interested only in tokens which are translated worse. For this reason \textit{ForgetGenUse} minimises reward for beneficial vocabulary shift by only marking no-longer-correctly-output tokens per segment.

\subsection{Intentionally triggering forgetting: Lower quality and detrimental vocabulary shift}
Our first experiments intentionally trigger forgetting to explore what is forgotten. We pre-train one encoder-decoder Transformer model for each of German to English (de-en) and English to Japanese (en-ja) NMT -- all subsequent adaptation experiments are a fine-tuning run of one of these models. Appendix A gives details of model preparation.

Our generic test sets are concatenated WMT News/General test sets\footnote{See [https://machinetranslate.org.}](https://machinetranslate.org.}) for 2019-22 for de-en and 2020-22 for en-ja. While WMT news sets are often described as `generic', each may feature quite specific vocabulary -- for example, articles about recent news items. Combining test sets increases the reliability of forgetting evaluation via the increased segment count, as well as being more truly generic in topic coverage.

Our adaptation domains are drawn from widely-used datasets with standard test splits. For de-en, we adapt to the five domains from the OPUS multi-domain split produced by Aharoni & Goldberg (2020)\footnote{We use the size-capped Subtitles set provided.}, including test sets. For en-ja we use three target domains: IWSLT (Cettolo et al., 2012), KFTT (Neubig, 2011) and BSD (Rikters et al., 2019). We use test15 as test data for en-ja IWSLT and the standard test splits for the remainder. The datasets, listed in Table 1, vary in domain and size.

We measure vocabulary shift forgetting via increased \textit{ForgetGenUse}, and track quality degradation via decreases in a string-based metric, BLEU, and a neural metric, COMET\footnote{wmt20-comet-da} (Rei et al., 2020). \textit{ForgetGenUse} expresses forgetting in the sense of vocabulary shift. Throughout this paper unless stated otherwise we report a drop in BLEU or COMET relative to the baseline as positive for brevity - high $\Delta$ meaning more forgetting. For reference, Table 1 gives generic and in-domain absolute BLEU and COMET scores for the pre-trained models, from which all other absolute values can be calculated.

We fine-tune our pre-trained models on domain-specific datasets until catastrophic forgetting is seen in the sense of quality drop on generic test sets. As we wish to understand the impact of dataset on forgetting independent of other variables, all experiments in this paper adapt for 20K steps. We found this caused similar forgetting to that previously described in the literature (Hasler et al., 2021).

Table 2 shows generic forgetting after adaptation [MISSING]


\subsection{Which tokens are forgotten, and what replaces them?}
\begin{table}[t]
\centering
\small
\begin{tabular}{llrl|llrl|llrl|llrl|llrl}
\toprule
\multicolumn{4}{c|}{IT} & \multicolumn{4}{c|}{Kor} & \multicolumn{4}{c|}{Law} & \multicolumn{4}{c|}{Med} & \multicolumn{4}{c}{Sub} \
Generic &  & \multicolumn{2}{c|}{Adapted} & Generic &  & \multicolumn{2}{c|}{Adapted} & Generic &  & \multicolumn{2}{c|}{Adapted} & Generic &  & \multicolumn{2}{c|}{Adapted} & Generic &  & \multicolumn{2}{c}{Adapted} \
\midrule
species   & 2   & types     & 664  & satisfied & 3   & pleased   & 90   & euros    & 39  & EUR       & 4988 & danger  & 3  & risk     & 5466 & not     & 21.1K & n't   & 50.6K \
citizens  & 0   & people    & 292  & week      & 0   & month     & 35   & warranty & 20  & guarantee & 2331 & defeat  & 0  & loss     & 1377 & i.e.    & 6273  & so    & 10.8K \
infections& 0   & cases     & 207  & England   & 0   & Kingdom   & 10   & Donald   & 0   & President & 1685 & billion & 0  & million  & 464  & autumn  & 16    & fall  & 477   \
victory   & 1   & win       & 120  & accident  & 0   & injury    & 7    & touch    & 5   & contact   & 948  & guests  & 0  & visitors & 11   & aircraft& 38    & plane & 435   \
Trump     & 0   & Donald    & 7    & Internet  & 0   & web       & 1    & wants    & 9   & intends   & 416  & game    & 0  & match   & 5    & VAT     & 1     & sales & 64    \
\bottomrule
\end{tabular}
\caption{High \textit{ForgetGenUse} tokens for de-en domains - counts are for that token \textit{in the in-domain adaptation dataset}. Left columns: Output from generic model. Right columns: Most frequent aligned replacements post-adaptation.}
\end{table}

Vocabulary shift in a domain-adapted NMT system can be beneficial or detrimental. Beneficial vocabulary shift produces in-domain tokens in in-domain contexts, and out-of-domain tokens where more contextually appropriate. Detrimental vocabulary shift produces in-domain vocabulary tokens when it is not contextually appropriate.

To make this distinction and find the token-level replacements after adaptation to each domain, we compare the generic-model and adapted-model translations of the generic test sets. We align the two sets of translations using symmetrized fast align (Dyer et al., 2013), which lets us identify which translation hypothesis tokens change after adaptation. We can also find the frequency of those tokens in the in-domain adaptation dataset.

Table 3 shows examples selected from the most `forgotten' tokens for each de-en domain. Invariably, replacements have at least one token appearing in the in-domain adaptation dataset. Tokens which themselves appear in the adaptation dataset are replaced less frequently, and only by alternatives with far more adaptation set occurrences. The replacements are often semantically similar, judged both by manual inspection and by average FastText embedding cosine similarity (Bojanowski et al., 2017) between the original and replacing tokens.

Surprisingly, we find by inspection that the replacements tend to occur in very different contexts in the adaptation data and generic test set. Of the seven IT domain instances of \textit{Donald}, two refer to computer scientist Knuth and five are subworded \textit{Mc_} or \textit{Mac_ + Donald} -- none have the same referent as \textit{Trump}. \textit{Internet} is legitimately replaced by \textit{web} after adaptation to Kor, but the Kor text only uses \textit{web} in the sense of spider's web -- including a different source term (\textit{Internet} vs \textit{Netz}). The Med domain only uses \textit{match} as a verb in the context of experiments, not as a noun synonym for \textit{game} as in Med-adapted test outputs -- not only a different source term but a different source part of speech (\textit{Spiel} vs e.g.\ \textit{abstimmen}). The target vocabulary alone can influence forgetting, without requiring a contextually relevant source.

Focusing on the most-forgotten Kor domain, we perform a deeper analysis for two tokens that are forgotten vs two that are not forgotten. Using Fast-Text embedding cosine similarity, we find the closest Kor-domain English tokens which can have the same part-of-speech. For each, the in-domain training count is in brackets:
\begin{quote}
\textit{satisfied} (3): \textit{happy} (29) and \textit{pleased} (90)\
\textit{water} (236): \textit{waters} (8) and \textit{lake} (1)\
\textit{England} (0): \textit{Kingdom} (10)\
\textit{genes} (0): \textit{species} (3)
\end{quote}

When the generic model translates the generic test set, it produces \textit{satisfied} 11 times. The Kor-adapted model produces \textit{pleased} for 10 of these, and \textit{happy} for the remaining. Although all are in-domain, \textit{satisfied} is far rarer. By contrast both models produce \textit{water}, with no more frequent in-domain alternative, in the same locations.

By contrast, we consider out-of-domain tokens. The generic model produces \textit{England} 14 times. The Kor-adapted model replaces 10 of these with \textit{United Kingdom}, with the remaining four null-aligned -- indicating undertranslation. Although the phrase \textit{United Kingdom} does not occur in the Kor data, both words do occur separately. \textit{United Kingdom} occurs in similar contexts to \textit{England} during pre-training, making it a plausible, if incorrect, replacement. Interestingly, another out-of-domain term, \textit{genes}, is not forgotten during adaptation. The closest in-domain alternative, \textit{species}, is neither common nor a plausible replacement.

The token forget-replace effect can be triggered by individual subwords, not just whole-word tokens. For example, ignoring post-processing, the pre-trained model produces one token \textit{October} where the Kor model produces two subwords \textit{oc_ + tober}. Neither word is in the Kor domain - but the subword \textit{oc_} is, making \textit{oc_ + tober} preferred.


\subsection{Out-of-domain tokens are forgotten more}
Given possible different requirements for in-domain (ID) and out-of-domain (OOD) tokens, it is interesting to calculate \textit{ForgetGenUse}$*{set={ID|OOD}}$ separately for these token subsets. For \textit{ForgetGenUse}$*{ID}$ we sum and normalize in Equation 1 over all vocabulary tokens that appear in at least one adaptation set reference sentence for each domain. For \textit{ForgetGenUse}$_{OOD}$ we do so for the complement, again for each domain.

The results in Table 4 show a striking difference in token shift between in-domain and out-of-domain tokens. \textit{ForgetGenUse}$*{ID}$ has relatively small absolute values, and a small range of values. \textit{ForgetGenUse}$*{OOD}$ values by contrast are higher for every domain, meaning out-of-domain tokens are forgotten at a higher rate. \textit{ForgetGenUse}$*{ID}$ and \textit{ForgetGenUse}$*{All}$ are equal for Law and Sub (de-en) and IWSLT and KFTT (en-ja): for these domains, almost all generic test set tokens are in-domain.

It is not wholly surprising that out-of-domain tokens are forgotten more than in-domain tokens: a goal of adaptation is to use in-domain terminology instead of generic. However, the vocabulary shift reported by \textit{ForgetGenUse} does not just consist of generic terms being replaced by their in-domain equivalents. Instead, as shown in Table 3, shifts can be technically correct but not domain-relevant (\textit{game} $\rightarrow$ \textit{match}, \textit{Trump} $\rightarrow$ \textit{Donald}) -- these are unnecessary and can confuse users. While the definition of an NMT domain is an open question (van der Wees et al., 2015; Saunders, 2022), it is not at all clear that a user or machine translation client would expect a subtitles domain to entail a shift to US-English terms like \textit{fall} or \textit{aircraft}, or expect an adapted model to no longer use standard but incidentally out-of-domain terms like \textit{accident} or \textit{species}. More serious still are meaning-changing errors (\textit{billion} $\rightarrow$ \textit{million}, \textit{week} $\rightarrow$ \textit{month}) -- these unambiguously harm translation. Such vocabulary shift is clearly detrimental and lowers quality.


\section{Why does forgetting vary by domain?}
In this section we aim to understand the relationship between adaptation dataset and forgetting. This relationship is key for real world adaptation scenarios when deciding whether to adapt, how to adjust tuning hyperparameters, and which if any forgetting mitigation steps to take. To investigate, we compare datasets exhibiting varying degrees of forgetting in terms of multiple domain-differentiating heuristics. We find that many domain features do not correlate with forgetting, but that vocabulary coverage does.


\subsection{Controlling for dataset size}
Dataset size is recognized as having an impact on MT adaptation performance (Sharaf et al., 2020), and has been associated in forgetting (Pham et al., 2020). However, its relationship with forgetting across domains is unclear. We can assess correlation of forgetting with number of lines per dataset for our results in Table 2. Surprisingly, Kendall's $\tau$ is not significant between dataset size and either of $\Delta$COMET or $\Delta$BLEU. \textit{ForgetGenUse} does show significant negative correlation with dataset size ($\tau=-0.7\ p<0.05$), suggesting smaller datasets have a greater likelihood of vocabulary shift, but not necessarily general quality degradation.

We further investigate by controlling for dataset size in terms of tokens. We randomly subsample each de-en dataset except for Kor to the same ap-[MISSING]


\subsection{Controlling segment length and quality}
Segment length and alignment quality both have potential causative links with catastrophic forgetting. Segment length distribution has been used as a domain feature (Varis and Bojar, 2021). Short segments in particular can be ambiguous to translate, making them candidates for problematic adaptation (Wan et al., 2022). Poorly aligned segment pairs likewise can cause hallucinations when used for adaptation (Saunders and Byrne, 2020).

We investigate the effect of length on forgetting by adapting to subsets of the domains with the shortest segment pairs. We subsample again to the approximate token count of Kor/BSD, allowing direct comparison with the Table 5 subsampling results. We focus on de-en Law vs Sub, which originally have the longest and shortest average segment lengths respectively.

If change in segment length corresponds to domain shift, we might expect a large forgetting main shift for Law-ss relative to Law-s, and a small change for Sub-ss relative to Sub-s. Surprisingly, Table 6 shows precisely the reverse. Forgetting for short-segment Law-ss is similar to random-segment Law-s, even though the change in average example length is 49 tokens. By contrast, tuning on Sub-ss results in extreme forgetting relative to Sub-s, which is only 10.5 tokens longer on average. For en-ja, the larger length shift KFTT-s to KFTT-ss results in a larger forgetting shift than for the IWSLT domain. However, in both cases the results are between the extremes seen for de-en. We propose that relative segment length between domains is not necessarily informative, but that a high proportion of very short segment lengths accelerates forgetting.

\begin{table}[t]
\centering
\small
\begin{tabular}{lrrrrr|rrrr}
\toprule
& \multicolumn{5}{c|}{de-en} & \multicolumn{4}{c}{en-ja} \
& Law-s & Law-ss & Sub-s & Sub-ss & Sub-ssf & IWSLT-s & IWSLT-ss & KFTT-s & KFTT-ss \
\midrule
Av.\ #toks & 66.1 & 17.0 & 23.0 & 12.5 & 13.6 & 44.4 & 15.7 & 60.8 & 11.2 \
$\Delta$BLEU & 12.3 & 12.4 & 11.5 & 30.4 & 15.1 & 7.2 & 10.4 & 6.9 & 11.3 \
$\Delta$COMET & 0.28 & 0.27 & 0.24 & 1.27 & 0.34 & 0.20 & 0.44 & 0.28 & 0.59 \
ForgetGenUse$_{\mathrm{all}}$ & 0.15 & 0.15 & 0.15 & 0.42 & 0.19 & 0.17 & 0.23 & 0.17 & 0.23 \
\bottomrule
\end{tabular}
\caption{Forgetting on generic sets, adapting on subsampled datasets. We sample randomly (-s) or sample the shortest (-ss) lines by source plus target token count. Sub-ssf pre-filters the shortest lines using LASER.}
\end{table}

On inspection the Sub-ss dataset contains many badly aligned source-target pairs. We hypothesize that these may encourage forgetting. To test this we produce a short-subsampled version filtered for quality, Sub-ssf. The shortest examples are sampled after alignment-filtering using LASER.\footnote{[https://github.com/facebookresearch/LASER](https://github.com/facebookresearch/LASER), cut-off score 0.8 selected by inspection.} The scores when adapting to Sub-ssf are less dramatically different to Sub-s, although still quite different to the Law-s-to-Law-ss forgetting. The only other domain with a significant proportion of low LASER score segments is Kor. Adapting to a similarly LASER-filtered Kor set gives scores 0.3 BLEU worse and 0.01 COMET better than adapting to the full Kor set, with no change in \textit{ForgetGenUse}: dataset quality cannot fully explain forgetting. Indeed, the low-quality Sub-ss pairs are also present in the full Sub dataset, which showed little forgetting (Table 2). Data noise in small enough proportions is not too harmful in these experiments, in line with the findings of Khayrallah & Koehn (2018).


\subsection{Corpus-level score domain heuristics}
We investigate the use of corpus-level scores as domain heuristics: negative log-likelihood (NLL) under the pre-trained model, Jensen-Shannon Divergence (JSD) (Lin, 1991) between the pre-training dataset and in-domain vocabulary distributions, and the generic vocabulary coverage of each in-domain dataset. Unlike the previous heuristics, we cannot easily control for these by subsampling to obtain datasets with equivalent values. Instead we find their correlation with forgetting metrics. Table~7 gives both heuristics and forgetting metrics.

\begin{table}[t]
\centering
\small
\begin{tabular}{lrrrrr|rrr}
\toprule
& \multicolumn{5}{c|}{de-en} & \multicolumn{3}{c}{en-ja} \
& IT & Kor & Law & Med & Sub & IWSLT & KFTT & BSD \
\midrule
$\Delta$BLEU & 5.0 & 22.3 & 4.7 & 8.3 & 5.7 & 4.8 & 2.0 & 7.0 \
$\Delta$COMET & 0.11 & 0.78 & 0.08 & 0.16 & 0.09 & 0.07 & 0.06 & 0.29 \
ForgetGenUse$_{\mathrm{all}}$ & 0.09 & 0.25 & 0.07 & 0.11 & 0.09 & 0.14 & 0.11 & 0.16 \
\midrule
Generic NLL & -2.1 & -2.4 & -1.4 & -1.8 & -2.6 & -1.7 & -1.6 & -2.1 \
Src-vcb JSD & 0.42 & 0.50 & 0.44 & 0.42 & 0.42 & 0.30 & 0.38 & 0.39 \
Trg-vcb JSD & 0.39 & 0.46 & 0.39 & 0.40 & 0.40 & 0.32 & 0.42 & 0.39 \
Src-vcb cover & 0.69 & 0.23 & 0.70 & 0.63 & 0.75 & 0.61 & 0.79 & 0.31 \
Trg-vcb cover & 0.52 & 0.23 & 0.59 & 0.48 & 0.62 & 0.62 & 0.72 & 0.29 \
\midrule
Src-vcb cover (-s) & 0.50 & - & 0.43 & 0.44 & 0.52 & 0.45 & 0.52 & - \
Trg-vcb cover (-s) & 0.39 & - & 0.34 & 0.34 & 0.45 & 0.41 & 0.46 & - \
\bottomrule
\end{tabular}
\caption{Corpus-level score domain heuristics, with forgetting measures for reference. Generic NLL and vocab JSD: closer to 0 is more similar to generic. Final lines: vocab coverage for downsampled domains of Table 5.}
\end{table}

For generic model likelihood, we score a 10K segment sample of the domain under the generic, pre-trained model. We use length-normalized NLL to indicate similarity to the generic domain without conflating with average segment length. The results do not show a clear relationship with forgetting: Kor and Sub for example have similar NLL but very different forgetting characteristics. Overall we find NLL has a weakly significant correlation with $\Delta$BLEU ($\tau$=0.5, p$<$0.1) and no significant correlation with $\Delta$COMET or ForgetGenUse.

We calculate vocabulary distribution divergence between the generic and in-domain vocabularies using JSD.\footnote{As proposed by Lu et al.\ (2020) we use unweighted JSD to disentangle vocabulary distribution from relative data size.} The de-en domain with the greatest divergence from the generic vocabulary -- Kor -- is indeed the domain with the most forgetting. For en-ja the highest-forgetting domain has a similar JSD to other domains. As well, neither source nor target JSD varies strongly between domains, reducing its utility as a forgetting heuristic. Neither source nor target JSD have a significant Kendall's $\tau$ with any of the three forgetting metrics.

Finally, we calculate vocabulary coverage for each domain. We define coverage as the proportion of the generic subword vocabulary that appears at all in the preprocessed segments for a given domain, calculated separately over source and target segments. Both source and target vocabulary coverage vary strongly across domains and have a significant inverse correlation with $\Delta$COMET ($\tau$=0.6/0.9 source/target, p$<$0.05). $\Delta$BLEU has a significant correlation with target coverage ($\tau$=0.7 p$<$0.05) and weakly significant with source coverage ($\tau$=0.6 p$<$0.1). Interestingly, ForgetGenUse only has a significant correlation with source coverage ($\tau$=0.7 p$<$0.05). Although we observed in Section 2 that detrimental vocabulary shift occurs regardless of source content in the \textit{test} sentence, it does correlate with lower vocabulary similarity between source adaptation sentences.

Vocabulary coverage could also explain the increase in forgetting when aggressively subsampling a dataset, as the number of sentence pairs correlates strongly and significantly with the number of unique vocabulary tokens. Indeed, when we include metrics and coverage for the subsampled domains (final lines of Table 7), we see significant and strong correlation between coverage and all forgetting metrics.


\section{Understanding generic data mix-in}
\begin{table}[t]
\centering
\small
\begin{tabular}{lrr}
\toprule
Domain & Random 1:1 & Minimal Mix-in \
\midrule
\multicolumn{3}{l}{de-en} \
IT  & 222927 & 18861 \
Kor & 17982  & 22769 \
Law & 467309 & 17485 \
Med & 248099 & 19605 \
Sub & 500000 & 16632 \
\multicolumn{3}{l}{en-ja} \
IWSLT & 219716 & 11205 \
KFTT  & 427353 & 8547 \
BSD   & 20000  & 16860 \
\bottomrule
\end{tabular}
\caption{Number of generic mix-in lines for each strategy. \textit{Random 1:1} is by definition the same size as the in-domain dataset, and \textit{Minimal Mix-in} is often far smaller.}
\end{table}

In the previous section, we found that adaptation dataset vocabulary coverage has a strong negative correlation with forgetting. A natural question follows: what would be the effect of ensuring all of these adaptation datasets had 100% vocabulary coverage? To answer, we propose and perform \textit{Minimal Mix-in}, a targeted variant of mixed fine-tuning (Chu et al., 2017). We focus on target coverage and the quality degradation metrics BLEU and COMET, both for brevity and as these had the strongest relationship with vocabulary coverage.

Mixed fine-tuning aims to mitigate forgetting by mixing examples from the generic training set into the adaptation set. For \textit{Minimal Mix-in}, we add generic examples to the adaptation set if they include a target token that is not in the adaptation dataset so far. Aside from the novelty of targeted mix-in data, our goal is to examine the effect of improving the vocabulary coverage with minimal other change to the adaptation data and no change at all to the model architecture, adaptation or inference procedure. Excepting Kor and BSD, \textit{Minimal Mix-in} produces an adaptation dataset where fewer than 10% of examples are generic.

To benchmark the forgetting mitigation possible with a similar non-minimal data augmentation, we follow a popular mixed fine-tuning recipe found in the literature (Haque et al., 2020; Hasler et al., 2021) which uses a 1:1 ratio of randomly sampled generic segments to in-domain segments. We refer to this as \textit{Random 1:1}. Table 8 summarizes the size of the different mix-in interventions.


\subsection{Less than 10% of the mix-in data can mitigate 80% of the forgetting}
We compare forgetting for adaptation with no mix-in, random 1:1 mix-in, and minimal mix-in. Table 9 reports forgetting and in-domain scores for each approach. We report quality changes as relative to the pre-trained model: negative is improved performance, positive is lower. Both random 1:1 and minimal mix-in reliably improve forgetting, with minimal mix-in often matching or exceeding random mix-in. The one exception is the BSD domain, where minimal mix-in mitigates forgetting less effectively.

Across the de-en domains, minimal mix-in uses on average 6.1% the number of generic examples that 1:1 mix-in uses, but achieves 87% of the generic COMET recovery and 83% of the generic BLEU recovery. For en-ja, minimal mix-in uses on average 16.7% the number of generic examples, and achieves 57% and 62% of COMET and BLEU recovery. Minimal mix-in recovers relatively less for en-ja because the initial amount of forgetting without mix-in is smaller. For BSD, most in-domain vocabulary is not in-domain, so minimal mix-in includes almost the entire original generic dataset, but it is still far less than the 1:1 random mix-in. We further discuss the specific failure case of BSD in Section 3.2.

In-domain scores show minimal differences, with mix-in often harming in-domain performance slightly. This is expected: in-domain datasets are larger with 1:1 mix-in, so it is possible the gains in forgetting mitigation could come partly from the reduction in in-domain focus. Nonetheless, minimal mix-in and random 1:1 are nearly identical in this regard, making mix-in size alone an insufficient explanation of forgetting mitigation.

In summary, generic data mix-in can mitigate forgetting primarily by ensuring generic vocabulary coverage. Much of the forgetting mitigation can be obtained by the addition of relatively little generic data.


\subsection{Minimal mix-in, better in-domain scores}
A primary goal of adapting NMT is improved in-domain translation. Table 10 gives quality metric deltas on the in-domain test sets: higher values are now better. A 1:1 generic ratio has a negative impact, with noticeable BLEU and COMET drops relative to unmixed fine-tuning. By contrast, \textit{Minimal Mix-in} scores similarly to unmixed fine-tuning for all except de-en Med. Improvement in terms of $\Delta$COMET shows less variation than under $\Delta$BLEU, possibly because COMET assigns higher scores to paraphrases which may not use domain-specific terminology. Mixing in large amounts of generic data reduces scores relative to \textit{Minimal Mix-in}. It is interesting to note that for the smallest domain, Kor, mixing no generic data also leads to reduced in-domain performance.

\section{Conclusions}
This paper investigates what is forgotten during NMT domain adaptation, and why. We show that vocabulary shift during adaptation is not necessarily beneficial, and that detrimental shift can be orthogonal to quality metrics. We find forgetting correlates with in-domain vocabulary coverage, allowing better prediction of how adaptation will behave on a particular dataset. Our findings emphasise that NMT adaptation research should not be dataset agnostic: in-domain data characteristics are critical to how adaptation can succeed or fail.


\section*{Limitations}
Since our investigation is dataset-dependent, it is necessarily limited by the data and languages we have used. We report on a selection of widely used, diverse domain-specific datasets, as available for two language pairs with contrasting resources and distance. Additional language pairs or domains would allow us to generalise better.

Another limitation is model variety. In the interests of brevity, time and cost we only conduct our experiments with moderately sized Transformers trained for NMT. There has been much recent interest in machine translation by prompting Large Language Models (LLMs) pre-trained on huge uncurated datasets (Zhang et al., 2023). Work concurrent with ours by Pang et al (2024) observe that LLMs also struggle with domain-specific translation. Indeed, when fine-tuning on the same de-en OPUS domain-specific datasets as us, they report that LLMs exhibit similar behaviour in terms of `forgetting' domain-specific terminology and preference to tokens appearing in the adaptation set, although they do not attempt to explain or mitigate this. We leave confirming experiments to future work.


\section*{References}
[MISSING]

Makoto Morishita, Katsuki Chousa, Jun Suzuki, and Masaaki Nagata. 2022. JParaCrawl v3.0: A large-scale English-Japanese parallel corpus. In \textit{Proceedings of the Thirteenth Language Resources and Evaluation Conference}, pages 6704--6710, Marseille, France. European Language Resources Association.

Graham Neubig. 2011. The Kyoto free translation task. \texttt{[http://www.phontron.com/kftt}](http://www.phontron.com/kftt}).

Jianhui Pang, Fanghua Ye, Longyue Wang, Dian Yu, Derek F Wong, Shuming Shi, and Zhaopeng Tu. 2024. Salute the classic: Revisiting challenges of machine translation in the age of large language models. \textit{arXiv preprint arXiv:2401.08350}.

Kishore Papineni, Salim Roukos, Todd Ward, and Wei-Jing Zhu. 2002. Bleu: a method for automatic evaluation of machine translation. In \textit{Proceedings of the 40th Annual Meeting of the Association for Computational Linguistics}, pages 311--318, Philadelphia, Pennsylvania, USA. Association for Computational Linguistics.

Minh Quang Pham, Josep Maria Crego, Fran\c{c}ois Yvon, and Jean Senellart. 2020. A study of residual adapters for multi-domain neural machine translation. In \textit{Proceedings of the Fifth Conference on Machine Translation}, pages 617--628, Online. Association for Computational Linguistics.

Matt Post. 2018. A call for clarity in reporting BLEU scores. In \textit{Proceedings of the Third Conference on Machine Translation: Research Papers}, pages 186--191, Brussels, Belgium. Association for Computational Linguistics.

Ricardo Rei, Craig Stewart, Ana C Farinha, and Alon Lavie. 2020. COMET: A neural framework for MT evaluation. In \textit{Proceedings of the 2020 Conference on Empirical Methods in Natural Language Processing (EMNLP)}, pages 2685--2702, Online. Association for Computational Linguistics.

Mat={\i}ss Rikters, Ryokan Ri, Tong Li, and Toshiaki Nakazawa. 2019. Designing the business conversation corpus. In \textit{Proceedings of the 6th Workshop on Asian Translation}, pages 54--61, Hong Kong, China. Association for Computational Linguistics.

Danielle Saunders. 2022. Domain adaptation and multi-domain adaptation for neural machine translation: A survey. \textit{Journal of Artificial Intelligence Research}, 75:351--424.

Danielle Saunders and Bill Byrne. 2020. Addressing exposure bias with document minimum risk training: Cambridge at the WMT20 biomedical translation task. In \textit{Proceedings of the Fifth Conference on Machine Translation}, pages 862--869, Online. Association for Computational Linguistics.

Konstantin Savenkov and Michel Lopez. 2022. The state of the machine translation 2022. In \textit{Proceedings of the 15th Biennial Conference of the Association for Machine Translation in the Americas (Volume 2: Users and Providers Track and Government Track)}, pages 32--49, Orlando, USA. Association for Machine Translation in the Americas.

Rico Sennrich, Barry Haddow, and Alexandra Birch. 2016. Neural machine translation of rare words with subword units. In \textit{Proceedings of the 54th Annual Meeting of the Association for Computational Linguistics (Volume 1: Long Papers)}, pages 1715--1725, Berlin, Germany. Association for Computational Linguistics.

Chenze Shao and Yang Feng. 2022. Overcoming catastrophic forgetting beyond continual learning: Balanced training for neural machine translation. In \textit{Proceedings of the 60th Annual Meeting of the Association for Computational Linguistics (Volume 1: Long Papers)}, pages 2023--2036, Dublin, Ireland. Association for Computational Linguistics.

Amr Sharaf, Hany Hassan, and Hal Daum'e III. 2020. Meta-learning for few-shot NMT adaptation. In \textit{Proceedings of the Fourth Workshop on Neural Generation and Translation}, pages 43--53, Online. Association for Computational Linguistics.

Brian Thompson, Jeremy Gwinnup, Huda Khayrallah, Kevin Duh, and Philipp Koehn. 2019. Overcoming catastrophic forgetting during domain adaptation of neural machine translation. In \textit{Proceedings of the 2019 Conference of the North American Chapter of the Association for Computational Linguistics: Human Language Technologies, Volume 1 (Long and Short Papers)}, pages 2062--2068, Minneapolis, Minnesota. Association for Computational Linguistics.

Marlies van der Wees, Arianna Bisazza, Wouter Weerkamp, and Christof Monz. 2015. Whatâ€™s in a domain? Analyzing genre and topic differences in statistical machine translation. In \textit{Proceedings of the 53rd Annual Meeting of the Association for Computational Linguistics and the 7th International Joint Conference on Natural Language Processing (Volume 2: Short Papers)}, pages 560--566, Beijing, China. Association for Computational Linguistics.

Dusan Varis and Ond\v{r}ej Bojar. 2021. Sequence length is a domain: Length-based overfitting in transformer models. In \textit{Proceedings of the 2021 Conference on Empirical Methods in Natural Language Processing}, pages 8246--8257, Online and Punta Cana, Dominican Republic. Association for Computational Linguistics.

Ashish Vaswani, Samy Bengio, Eugene Brevdo, Fran\c{c}ois Chollet, Aidan Gomez, Stephan Gouws, Llion Jones, \L{}ukasz Kaiser, Nal Kalchbrenner, Niki Parmar, Ryan Sepassi, Noam Shazeer, and Jakob Uszkoreit. 2018. Tensor2Tensor for neural machine translation. In \textit{Proceedings of the 13th Conference of the Association for Machine Translation in the Americas (Volume 1: Research Track)}, pages 193--199, Boston, MA. Association for Machine Translation in the Americas.

Yu Wan, Baosong Yang, Derek Fai Wong, Lidia Sam Chao, Liang Yao, Haibo Zhang, and Boxing Chen. 2022. Challenges of neural machine translation for short texts. \textit{Computational Linguistics}, 48(2):321--342.

Jitao Xu, Josep Crego, and Jean Senellart. 2019. Lexical micro-adaptation for neural machine translation. In \textit{Proceedings of the 16th International Conference on Spoken Language Translation}, Hong Kong. Association for Computational Linguistics.

Xuan Zhang, Navid Rajabi, Kevin Duh, and Philipp Koehn. 2023. Machine translation with large language models: Prompting, few-shot learning, and fine-tuning with QLoRA. In \textit{Proceedings of the Eighth Conference on Machine Translation}, pages 468--481, Singapore. Association for Computational Linguistics.

Xuan Zhang, Pamela Shapiro, Gaurav Kumar, Paul McNamee, Marine Carpuat, and Kevin Duh. 2019. Curriculum learning for domain adaptation in neural machine translation. In \textit{Proceedings of the 2019 Conference of the North American Chapter of the Association for Computational Linguistics: Human Language Technologies, Volume 1 (Long and Short Papers)}, pages 1903--1915, Minneapolis, Minnesota. Association for Computational Linguistics.


\appendix

\section{Experimental setup}
We pre-train two Transformer models using the Tensorflow T2T toolkit (Vaswani et al., 2018), one for each of German-English (de-en) and English-Japanese (en-ja). Both use BPE vocabulary (Sennrich et al., 2016), with details given in Table~11.

\begin{table}[t]
\centering
\begin{tabular}{lcc}
\hline
& de-en & en-ja \
\hline
Encoder layers & 15 & 18 \
Decoder layers & 3 & 3 \
Hidden size & 2560 & 2560 \
Filter size & 640 & 640 \
# BPE merges & 32K & 16K \
Shared BPE & Y & N \
\hline
\end{tabular}
\caption{Pre-trained model specifications}
\end{table}

Following findings from the most recent WMT shared task (Kocmi et al., 2023) on Transformer NMT models, we use deep encoders with relatively shallow decoders for a balance of speed and quality. We found a slightly deeper encoder and smaller, not shared BPE vocabulary gave better results for en-ja in initial testing.

The de-en model is pre-trained on 43.9M lines of parallel data made available via the WMT shared task: Paracrawl v9, Europarl v10, NewsCommentary v14, Tilde and WikiMatrix (Kocmi et al., 2022). The en-ja model is pre-trained on 22.4M lines of JParacrawl v3.0 (Morishita et al., 2022). When calculating BLEU for en-ja, we use Sacrebleu v2.0 (Post, 2018) with the Mecab tokenizer.

To minimize our computational and energy use, we pre-train each model only once on 4 GPUs for approximately two days. Each fine-tuning run of 20K steps takes approximately 1 additional hour of training.


\end{document}
=====END FILE=====
